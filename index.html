<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Family Wallet Pro</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap');
        body { font-family: 'Outfit', sans-serif; background: #f1f5f9; }
        .hidden { display: none !important; }
        header { padding-top: 40px !important; } /* Force content below notch */
        .tab-content { padding-bottom: 100px; }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center p-10 text-center text-white">
        <h1 class="text-4xl font-black mb-8">WalletPro</h1>
        <button onclick="login()" class="bg-white text-slate-900 px-8 py-4 rounded-2xl font-black flex items-center gap-4">
            Sign in with Gmail
        </button>
    </div>

    <div id="app-ui" class="hidden">
        <header class="bg-white px-5 pb-4 flex justify-between items-center border-b shadow-sm">
            <button onclick="toggleSidebar()" class="p-2 bg-slate-100 rounded-xl"><i data-lucide="menu"></i></button>
            <div class="flex items-center gap-2 bg-slate-100 px-3 py-2 rounded-xl">
                <button onclick="changeMonth(-1)"><i data-lucide="chevron-left"></i></button>
                <input type="month" id="globalMonth" class="bg-transparent font-black text-sm border-none p-0 w-28 text-center" onchange="loadData()">
                <button onclick="changeMonth(1)"><i data-lucide="chevron-right"></i></button>
            </div>
            <div class="w-8"></div>
        </header>

        <div id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-900 text-white z-50 -translate-x-full transition-transform p-8">
            <button onclick="toggleSidebar()" class="mb-10 text-slate-400">Close ×</button>
            <nav class="space-y-8">
                <button onclick="switchTab('expenses')" class="block text-xl font-bold">Monthly Spend</button>
                <button onclick="switchTab('savings')" class="block text-xl font-bold">Lifetime Wealth</button>
                <button onclick="logout()" class="block text-rose-400 font-bold pt-10">Logout</button>
            </nav>
        </div>

        <div id="tab-expenses" class="tab-content p-5 space-y-6 max-w-lg mx-auto">
            <div class="bg-white rounded-[2rem] p-6 shadow-lg text-center">
                <p class="text-xs font-bold text-slate-400 uppercase">Balance</p>
                <h1 id="display-net-savings" class="text-4xl font-black text-emerald-600 mb-6">₹0</h1>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="bg-blue-50 p-3 rounded-2xl"><p class="text-[10px] text-blue-400 font-bold uppercase">Income</p><p id="display-total-income" class="font-black text-blue-700">₹0</p></div>
                    <div class="bg-rose-50 p-3 rounded-2xl"><p class="text-[10px] text-rose-400 font-bold uppercase">Spent</p><p id="display-total-expenses" class="font-black text-rose-700">₹0</p></div>
                </div>
                <div class="flex gap-1">
                    <input type="number" id="inc-husband" onchange="saveIncome()" placeholder="H" class="w-1/3 text-center bg-slate-50 p-2 rounded-lg text-xs font-bold border-none">
                    <input type="number" id="inc-wife" onchange="saveIncome()" placeholder="W" class="w-1/3 text-center bg-slate-50 p-2 rounded-lg text-xs font-bold border-none">
                    <input type="number" id="inc-other" onchange="saveIncome()" placeholder="O" class="w-1/3 text-center bg-slate-50 p-2 rounded-lg text-xs font-bold border-none">
                </div>
            </div>
            <div class="bg-slate-900 rounded-[2rem] p-5">
                <select id="exp-cat" class="w-full p-3 bg-slate-800 text-white rounded-xl mb-2 border-none font-bold"></select>
                <div class="flex gap-2">
                    <input type="number" id="exp-amt" placeholder="Amount" class="flex-1 p-3 bg-slate-800 text-white rounded-xl border-none font-bold">
                    <button onclick="addExpense()" class="bg-blue-500 text-white px-6 rounded-xl font-black">ADD</button>
                </div>
            </div>
            <div id="budget-list" class="space-y-3"></div>
        </div>

        <div id="tab-savings" class="tab-content p-5 space-y-6 hidden max-w-lg mx-auto">
            <div class="bg-indigo-600 p-8 rounded-[2rem] text-white shadow-xl text-center">
                <p class="text-indigo-200 text-xs font-bold uppercase">Net Wealth</p>
                <h1 id="lifetime-savings" class="text-4xl font-black">₹0</h1>
            </div>
            <div id="saving-tiles" class="flex flex-col gap-4"></div>
        </div>
    </div>

    <div id="expense-detail-view" class="fixed inset-0 bg-white z-[70] hidden p-6 pt-20 overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 id="detail-cat-name" class="text-2xl font-black">Details</h2>
            <button onclick="closeExpenseDetails()" class="text-slate-400 font-bold">Close ×</button>
        </div>
        <div id="daily-log-list" class="space-y-3"></div>
    </div>

    <div id="saving-detail-view" class="fixed inset-0 bg-white z-[70] hidden p-6 pt-20 overflow-y-auto">
        <div class="flex justify-between mb-4"><h3 id="selected-saving-title" class="font-black text-2xl">Saving</h3><button onclick="closeSavingDetails()">×</button></div>
        <div class="bg-slate-50 p-4 rounded-2xl space-y-3 mb-6">
            <input type="date" id="sav-date" class="w-full p-3 rounded-xl border-none shadow-sm font-bold">
            <input type="number" id="sav-amt" placeholder="Amount" class="w-full p-3 rounded-xl border-none shadow-sm font-bold">
            <textarea id="sav-note" placeholder="Notes" class="w-full p-3 rounded-xl border-none shadow-sm"></textarea>
            <button onclick="addSavingLog()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-black">SAVE</button>
        </div>
        <div id="saving-log-list" class="space-y-2"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDy9Zx7MOhRFJc72HA_3bHqwsCUjjvWduA",
            authDomain: "family-pocket-41cee.firebaseapp.com",
            projectId: "family-pocket-41cee",
            storageBucket: "family-pocket-41cee.firebasestorage.app",
            messagingSenderId: "376381204269",
            appId: "1:376381204269:web:4a9c4ebfe8aa09a1f395a4"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.firestore(), provider = new firebase.auth.GoogleAuthProvider();
        let currentUser = null, userData = { months: {}, savings: { "Gold": [], "FD": [], "Stocks": [], "Post Office": [] } }, currentMonth = new Date().toISOString().slice(0, 7);
        const categories = [
            { name: "Petrol", color: "bg-red-100" }, { name: "EMI", color: "bg-orange-100" }, 
            { name: "Essentials", color: "bg-yellow-100" }, { name: "News paper", color: "bg-green-100" },
            { name: "Donations", color: "bg-emerald-100" }, { name: "Sports", color: "bg-cyan-100" },
            { name: "Outside Food", color: "bg-blue-100" }, { name: "Office tea", color: "bg-indigo-100" },
            { name: "Recharge", color: "bg-purple-100" }, { name: "Taxi", color: "bg-fuchsia-100" },
            { name: "Parents", color: "bg-pink-100" }, { name: "Entertainment", color: "bg-rose-100" },
            { name: "Others", color: "bg-slate-200" }
        ];
        auth.onAuthStateChanged(async (u) => { if(u){ currentUser=u; document.getElementById('login-screen').classList.add('hidden'); document.getElementById('app-ui').classList.remove('hidden'); await syncFromCloud(); render(); } });
        function login() { auth.signInWithPopup(provider); }
        function logout() { auth.signOut().then(() => location.reload()); }
        async function syncFromCloud() { const doc = await db.collection('users').doc(currentUser.uid).get(); if(doc.exists) userData = doc.data(); loadData(); }
        async function syncToCloud() { if(currentUser) await db.collection('users').doc(currentUser.uid).set(userData); }
        function loadData() {
            currentMonth = document.getElementById('globalMonth').value;
            if(!userData.months[currentMonth]) userData.months[currentMonth] = { income:{husband:0,wife:0,other:0}, spends:[], budgets:{} };
            const m = userData.months[currentMonth];
            document.getElementById('inc-husband').value = m.income.husband || '';
            document.getElementById('inc-wife').value = m.income.wife || '';
            document.getElementById('inc-other').value = m.income.other || '';
            render();
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
        function switchTab(t) {
            document.getElementById('tab-expenses').classList.toggle('hidden', t!=='expenses');
            document.getElementById('tab-savings').classList.toggle('hidden', t!=='savings');
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('-translate-x-full');
            render();
        }
        function changeMonth(d) {
            let [y,m] = currentMonth.split('-').map(Number); m+=d;
            if(m>12){y++;m=1} if(m<1){y--;m=12}
            currentMonth=`${y}-${m.toString().padStart(2,'0')}`;
            document.getElementById('globalMonth').value = currentMonth; loadData();
        }
        async function saveIncome() {
            const m = userData.months[currentMonth];
            m.income.husband = parseFloat(document.getElementById('inc-husband').value)||0;
            m.income.wife = parseFloat(document.getElementById('inc-wife').value)||0;
            m.income.other = parseFloat(document.getElementById('inc-other').value)||0;
            await syncToCloud(); render();
        }
        async function addExpense() {
            const cat = document.getElementById('exp-cat').value, amt = parseFloat(document.getElementById('exp-amt').value);
            if(!amt) return;
            userData.months[currentMonth].spends.push({ cat, amt, date: new Date().toLocaleDateString('en-GB') });
            document.getElementById('exp-amt').value = ''; await syncToCloud(); render();
        }
        async function updateBudget(cat, val, e) {
            e.stopPropagation(); userData.months[currentMonth].budgets[cat] = parseFloat(val)||0;
            await syncToCloud(); render();
        }
        function render() {
            const mData = userData.months[currentMonth]; if(!mData) return;
            const inc = Object.values(mData.income).reduce((a,b)=>a+b,0), exp = mData.spends.reduce((a,b)=>a+b.amt,0);
            document.getElementById('display-total-income').innerText = `₹${inc.toLocaleString()}`;
            document.getElementById('display-total-expenses').innerText = `₹${exp.toLocaleString()}`;
            document.getElementById('display-net-savings').innerText = `₹${(inc-exp).toLocaleString()}`;
            document.getElementById('exp-cat').innerHTML = categories.map(c=>`<option value="${c.name}">${c.name}</option>`).join('');
            const blist = document.getElementById('budget-list'); blist.innerHTML = '';
            categories.forEach(c => {
                const s = mData.spends.filter(x=>x.cat===c.name).reduce((a,b)=>a+b.amt,0), b = mData.budgets[c.name]||0;
                const d = document.createElement('div');
                d.className = `p-4 rounded-2xl flex justify-between items-center ${c.color}`;
                d.onclick = () => openExpenseDetails(c.name);
                d.innerHTML = `<div><p class="text-[10px] font-bold uppercase opacity-50">${c.name}</p><p class="text-lg font-black">₹${(b-s).toLocaleString()}</p></div>
                    <input type="number" value="${b}" onchange="updateBudget('${c.name}', this.value, event)" onclick="event.stopPropagation()" class="w-16 bg-white/50 p-1 rounded text-center text-xs font-bold border-none">`;
                blist.appendChild(d);
            });
            const sTiles = document.getElementById('saving-tiles'); sTiles.innerHTML = '';
            let totalS = 0; const sCols = {"Gold":"bg-amber-500","FD":"bg-blue-600","Stocks":"bg-emerald-600","Post Office":"bg-rose-600"};
            Object.keys(userData.savings).forEach(cat => {
                const total = userData.savings[cat].reduce((a,b)=>a+b.amt,0); totalS += total;
                const t = document.createElement('div');
                t.className = `${sCols[cat]} p-6 rounded-2xl text-white shadow-md`;
                t.onclick = () => openSavingDetails(cat);
                t.innerHTML = `<p class="text-xs font-bold opacity-70">${cat}</p><p class="text-2xl font-black">₹${total.toLocaleString()}</p>`;
                sTiles.appendChild(t);
            });
            document.getElementById('lifetime-savings').innerText = `₹${totalS.toLocaleString()}`;
            lucide.createIcons();
        }
        function openExpenseDetails(c) {
            const logs = userData.months[currentMonth].spends.filter(s=>s.cat===c);
            document.getElementById('detail-cat-name').innerText = c;
            document.getElementById('daily-log-list').innerHTML = logs.map((l,i)=>`<div class="flex justify-between p-4 bg-slate-50 rounded-xl"><div><p class="font-bold">₹${l.amt}</p><p class="text-[10px]">${l.date}</p></div><button onclick="deleteExp('${c}',${i})" class="text-rose-500">Delete</button></div>`).join('');
            document.getElementById('expense-detail-view').classList.remove('hidden');
        }
        function closeExpenseDetails() { document.getElementById('expense-detail-view').classList.add('hidden'); }
        async function deleteExp(c,idx) { 
            let count=0, m=userData.months[currentMonth];
            for(let i=0;i<m.spends.length;i++){ if(m.spends[i].cat===c){ if(count===idx){m.spends.splice(i,1); break;} count++; } }
            await syncToCloud(); render(); closeExpenseDetails(); 
        }
        let activeS = '';
        function openSavingDetails(c) { activeS=c; document.getElementById('selected-saving-title').innerText=c; document.getElementById('saving-detail-view').classList.remove('hidden'); renderSLogs(); }
        function closeSavingDetails() { document.getElementById('saving-detail-view').classList.add('hidden'); }
        async function addSavingLog() {
            const a=parseFloat(document.getElementById('sav-amt').value), d=document.getElementById('sav-date').value, n=document.getElementById('sav-note').value;
            if(!a||!d) return; userData.savings[activeS].push({amt:a,date:d,note:n});
            await syncToCloud(); render(); renderSLogs();
        }
        function renderSLogs() {
            document.getElementById('saving-log-list').innerHTML = userData.savings[activeS].map(l=>`<div class="p-3 bg-slate-50 rounded-lg"><p class="font-bold">₹${l.amt}</p><p class="text-[10px]">${l.date}</p><p class="text-xs italic">${l.note}</p></div>`).join('');
        }
        document.getElementById('globalMonth').value = currentMonth; lucide.createIcons();
    </script>
</body>
</html>

